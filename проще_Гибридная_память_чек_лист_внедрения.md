Ок, давай сделаем **упрощённую гибридную память для Люмы** — минимум сущностей, максимум пользы. Без векторных БД и сложной иерархии; всё ложится в твою текущую схему.

# 1) Архитектура «2+L»

Держим всего **две** дополнительные «памяти» + последние сообщения:

1. **Structured memory (JSON-слоты)** — компактные факты «долгоиграющие».
2. **Rolling summary (текст ≤ 450–600 токенов)** — сжатый конспект беседы.
3. **Последние L сообщений** — динамически по токен-бюджету (а не фиксированное «20 шт.»).

Этого хватает, чтобы «не забывать» и оставаться простыми.

---

# 2) Что хранить в Structured memory (диетология)

Мини-слоты (всё опционально, только подтверждённые факты):

* `goal`: цель (снижение/набор/поддержание, сроки, приоритет).
* `constraints`: медицинские/бытовые ограничения (аллергии, религ. ограничения, бюджет, кухня/время).
* `preferences`: вкусовые предпочтения/нежелательные продукты; формат «нравится/не нравится».
* `schedule`: режим дня (время приёмов пищи/работы), частые поездки/ночные смены.
* `history`: что уже «не зашло» (rejections) — **ключ для «не повторять»**.
* `targets`: ориентиры калорий/БЖУ (диапазоны), вода/шаги/сон — если согласованы.
* `progress_markers`: фиксации веса/замеров/ощущений (кратко, дата+значение).
* `reminder_pref`: пользователь хочет/не хочет напоминания (учёт твоей логики с /remind).
* `provenance`: id сообщений, откуда взято.

Обновляет **легкий Profiler** только по явным подтверждениям пользователя.

---

# 3) Rolling summary (одно поле)

Один текст до **450–600 токенов**:

* «О чём мы в целом», ключевые решения, что уже тестили, что не зашло, текущий фокус на сегодня/неделю.
* Отмечай изменения мнения как `outdated:` … (1 строка).
* Никаких лишних деталей/рецептов — это для ответов, не для памяти.

**Когда обновлять:**

* каждые 6–8 новых сообщений,
* при смене темы,
* при явных «решениях/отказах».

---

# 4) Сборка контекста (жёстко по токенам)

Ориентир: **≤ 900–1000 токенов** всего.

1. System (твой промпт) — как есть.
2. **Profile (юзерский)** — как у тебя уже.
3. **Structured memory (JSON-слоты)** — ≤ 200–250 токенов (печатай только заполненные поля).
4. **Rolling summary** — ≤ 450–600 токенов.
5. **Последние сообщения** — добавляй **по токен-остатку**, но всегда минимум последние 4–6 реплик; дальше добавляй, пока не упрёшься в лимит.
6. **Текущий вопрос**.

> Важно: уйди от «20 штук всегда». Делай **динамически по токенам**: «последние k пар», где k = столько, сколько влезает после профиль+summary.

---

# 5) Мини-триггеры

* Любое «запомни/не предлагай/мне не подходит» → апдейт `history` в structured memory.
* Любое «меняю цель/диету/режим» → замена в `goal/constraints/preferences` + `outdated` в summary.
* Прошёл день и было планирование → в summary короткий «итог дня» (1–2 строки), чтобы поддержать контекст привычек.

---

# 6) D.R.Y. промпты (минимум)

### Summarizer (≤ 500–600 токенов)

```
Ты — саммаризатор диалога. Обнови краткий конспект (≤600 токенов):
— Оставь только новое и важное: решения, отказанные варианты, текущий фокус (сегодня/неделя).
— Если что-то стало неактуальным, добавь строку вида: outdated: <что и чем заменено>.
— Не пересказывай рецепты/подробности, только опорные факты.

[OLD SUMMARY]
{old_summary}

[NEW MESSAGES]
{recent_messages}

Обновлённый конспект:
```

### Profiler (строго JSON; только подтверждённые факты)

```
Ты — профайлер. Обнови JSON-слоты по новым репликам.
Правила:
— Обновляй только явно подтверждённые факты.
— Новое точнее/свежее → замени. Размытое → игнорируй.
— Добавляй отказы в history.rejections как массив кратких пунктов.
— Сохраняй provenance: [message_ids].
Ответ: только JSON без комментариев.

EXISTING:
{existing_json}

MESSAGES:
{recent_messages}
```

*(Retriever/Validator в этой упрощённой версии не нужны.)*

---

# 7) Мелкие правки в твоём SYSTEM\_PROMPT (2 строки)

Добавь в конец раздела «Важные принципы»:

* «Учитывай structured memory: не предлагай повторно то, что пользователь ранее отверг (`history.rejections`).»
* «Учитывай rolling summary: не противоречь зафиксированным решениям; если пользователь изменил позицию, следуй свежей и не возвращай старую.»

---

# 8) Таблицы (простая версия)

* `messages(...)` — как сейчас.
* `memory_structured (id, user_id, json, updated_at)` — **одно поле JSON**.
* `memory_summary (id, user_id, text, updated_at, version)` — **одно поле TEXT**, храни последние 3 версии на откат.

---

# 9) Политика отказоустойчивости

* Если саммари не обновилось/пусто — используй предыдущую версию.
* Ограничь structured dump до **≤250 токенов**: печатай **только непустые поля** и короткие значения.
* Если суммарный контекст > лимита — урезай **в первую очередь** «последние сообщения», затем summary до 450; профиль и structured оставляй.

---

# 10) Дорожная карта апгрейда (по желанию)

1. «Лёгкий RAG» позже: брать 2–3 старые реплики по простому TF-IDF/ключевым словам (без эмбеддингов).
2. «Еженедельный ресинк»: раз в 7 дней пересобрать summary «с нуля» (из последних планов и фактов), чтобы убрать накопленную ошибку.

---

## Коротко

Самая простая и эффективная связка для твоего бота:

* **JSON-слоты** (goal/constraints/preferences/rejections/targets/…),
* **один rolling summary** (≤ 600 токенов),
* **последние сообщения — по токен-остатку**, а не «20 фикс».

Этого достаточно, чтобы Люма перестала «забывать» важное, не распухал контекст и не было повторов того, что пользователь уже отверг.
